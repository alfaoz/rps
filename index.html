<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>rps :3</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Comic Sans MS', 'Comic Sans', cursive;
      background: black;
      color: white;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      width: 100%;
      text-align: center;
    }

    h1 {
      font-size: 1.5em;
      margin-bottom: 30px;
      font-weight: normal;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    button {
      font-family: 'Comic Sans MS', 'Comic Sans', cursive;
      background: white;
      color: black;
      border: 2px solid white;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      margin: 10px 5px;
    }

    button.waiting-opponent {
      background: black;
      color: white;
      animation: blink 1s ease-in-out infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    button:hover {
      background: black;
      color: white;
    }

    button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .choice-btn {
      font-size: 3em;
      width: 80px;
      height: 80px;
      padding: 0;
      margin: 10px;
      background: black;
      color: white;
      border: 2px solid white;
    }

    .choice-btn:hover:not(:disabled) {
      background: white;
      color: black;
    }

    .choice-btn.selected {
      background: white;
      color: black;
    }

    input {
      font-family: 'Comic Sans MS', 'Comic Sans', cursive;
      background: black;
      border: 2px solid white;
      color: white;
      padding: 10px;
      font-size: 1em;
      text-align: center;
      width: 150px;
      margin: 10px;
    }

    input:focus {
      outline: none;
      border-color: white;
    }

    .share-link {
      border: 2px solid white;
      padding: 15px;
      margin: 20px 0;
      cursor: pointer;
    }

    .share-link:hover {
      background: white;
      color: black;
    }

    .status {
      font-size: 1.2em;
      margin: 20px 0;
      min-height: 30px;
    }

    .result {
      font-size: 1.5em;
      margin: 30px 0;
      padding: 20px;
      border: 2px solid white;
    }

    .error {
      margin: 20px 0;
      padding: 15px;
      border: 2px solid white;
    }

    .timer {
      font-size: 2em;
      margin: 20px 0;
      font-weight: bold;
    }

    small {
      font-size: 0.8em;
      opacity: 0.7;
    }

    .score {
      font-size: 0.9em;
      margin: 10px 0;
      cursor: pointer;
      opacity: 0.7;
    }

    .score:hover {
      opacity: 1;
    }

    .score.pending-reset {
      animation: blink 1s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>rock paper scissors :3</h1>

    <!-- Menu Screen -->
    <div id="menu" class="screen active">
      <button onclick="createRoom()">create game</button>
      <br>
      <input type="text" id="roomInput" placeholder="room code">
      <br>
      <button onclick="joinRoom()">join game</button>
      <div id="menuError" class="error" style="display: none;"></div>
    </div>

    <!-- Waiting Screen -->
    <div id="waiting" class="screen">
      <div class="status">room code:</div>
      <div class="share-link" id="shareLink" onclick="copyLink()">
        <div id="roomCode"></div>
        <small>click to copy link :'*</small>
      </div>
      <div class="status">waiting for friend...</div>
    </div>

    <!-- Game Screen -->
    <div id="game" class="screen">
      <div class="score" id="score" onclick="toggleResetScore()">you: 0 | them: 0</div>
      <div class="timer" id="timer">3</div>
      <div class="status" id="gameStatus">pick one!</div>
      <div>
        <button class="choice-btn" onclick="makeChoice('rock')">‚úä</button>
        <button class="choice-btn" onclick="makeChoice('paper')">‚úã</button>
        <button class="choice-btn" onclick="makeChoice('scissors')">‚úåÔ∏è</button>
      </div>
      <div id="result" class="result" style="display: none;"></div>
      <button onclick="playAgain()" style="display: none;" id="playAgainBtn">play again :3</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoom = null;
    let myChoice = null;
    let timerInterval = null;
    let timeLeft = 3;
    let myScore = 0;
    let theirScore = 0;
    let myPlayerIndex = null;
    let cherryMode = false;

    const screens = {
      menu: document.getElementById('menu'),
      waiting: document.getElementById('waiting'),
      game: document.getElementById('game')
    };

    const normalEmojis = { rock: '‚úä', paper: '‚úã', scissors: '‚úåÔ∏è' };
    const cherryEmojis = { rock: 'üçí', paper: 'üçíüçí', scissors: 'üçíüçíüçí' };

    function showScreen(screenName) {
      Object.values(screens).forEach(screen => screen.classList.remove('active'));
      screens[screenName].classList.add('active');
    }

    function createRoom() {
      // check if cherry mode should be enabled from URL
      const urlParams = new URLSearchParams(window.location.search);
      const roomParam = urlParams.get('room');
      if (roomParam && roomParam.toLowerCase() === 'cherry') {
        cherryMode = true;
      }
      socket.emit('create_room');
    }

    function joinRoom() {
      const roomId = document.getElementById('roomInput').value.trim();
      if (!roomId) {
        showError('please enter a room code :3');
        return;
      }

      // easter egg :'*
      if (roomId.toLowerCase() === 'kiraz') {
        showError('i love you!!!! - alfa ‚ô•');
        return;
      }

      // cherry mode easter egg
      if (roomId.toLowerCase() === 'cherry') {
        cherryMode = true;
        updateButtonEmojis();
        socket.emit('join_room', roomId.toUpperCase());
        return;
      }

      socket.emit('join_room', roomId.toUpperCase());
    }

    function updateButtonEmojis() {
      const emojis = cherryMode ? cherryEmojis : normalEmojis;
      const buttons = document.querySelectorAll('.choice-btn');
      buttons[0].textContent = emojis.rock;
      buttons[1].textContent = emojis.paper;
      buttons[2].textContent = emojis.scissors;
    }

    function startTimer() {
      timeLeft = 3;
      document.getElementById('timer').textContent = timeLeft;

      if (timerInterval) clearInterval(timerInterval);

      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').textContent = timeLeft;

        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          if (!myChoice) {
            // auto-select random choice if time runs out
            const choices = ['rock', 'paper', 'scissors'];
            const randomChoice = choices[Math.floor(Math.random() * choices.length)];
            makeChoice(randomChoice, true);
          }
        }
      }, 1000);
    }

    function makeChoice(choice, auto = false) {
      if (myChoice) return;

      myChoice = choice;
      socket.emit('make_choice', { roomId: currentRoom, choice });

      if (timerInterval) clearInterval(timerInterval);

      document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.classList.remove('selected');
        btn.disabled = true;
      });

      const buttons = document.querySelectorAll('.choice-btn');
      const choiceMap = { rock: 0, paper: 1, scissors: 2 };
      buttons[choiceMap[choice]].classList.add('selected');

      if (auto) {
        document.getElementById('gameStatus').textContent = "time up! auto-picked :'*";
      } else {
        document.getElementById('gameStatus').textContent = 'waiting for friend...';
      }
      document.getElementById('timer').textContent = '-';
    }

    function playAgain() {
      const btn = document.getElementById('playAgainBtn');
      btn.classList.add('waiting-opponent');
      btn.textContent = 'waiting for friend...';
      btn.disabled = true;

      socket.emit('ready_for_next', { roomId: currentRoom });
    }

    function copyLink() {
      const url = window.location.href.split('?')[0] + '?room=' + currentRoom;
      navigator.clipboard.writeText(url).then(() => {
        const linkDiv = document.getElementById('shareLink');
        const code = currentRoom;
        linkDiv.innerHTML = '<div>copied! :3</div>';
        setTimeout(() => {
          linkDiv.innerHTML = `<div id="roomCode">${code}</div><small>click to copy link :'*</small>`;
        }, 1500);
      });
    }

    function showError(message) {
      const errorDiv = document.getElementById('menuError');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 3000);
    }

    function updateScore() {
      document.getElementById('score').textContent = `you: ${myScore} | them: ${theirScore}`;
    }

    function toggleResetScore() {
      const scoreDiv = document.getElementById('score');
      const hasPending = scoreDiv.classList.contains('pending-reset');

      if (hasPending) {
        // Cancel reset
        scoreDiv.classList.remove('pending-reset');
        updateScore();
        socket.emit('cancel_reset', { roomId: currentRoom });
      } else {
        // Request reset
        scoreDiv.classList.add('pending-reset');
        scoreDiv.textContent = 'waiting for friend...';
        socket.emit('request_reset', { roomId: currentRoom });
      }
    }

    // Socket event listeners
    socket.on('room_created', (roomId) => {
      currentRoom = roomId;
      document.getElementById('roomCode').textContent = roomId;
      showScreen('waiting');
    });

    socket.on('room_joined', (roomId) => {
      currentRoom = roomId;
      showScreen('game');
      updateButtonEmojis();
    });

    socket.on('player_joined', ({ playerCount }) => {
      if (playerCount === 2) {
        showScreen('game');
        updateButtonEmojis();
        setTimeout(startTimer, 1000);
      }
    });

    socket.on('start_round', () => {
      myChoice = null;
      document.getElementById('result').style.display = 'none';
      const btn = document.getElementById('playAgainBtn');
      btn.style.display = 'none';
      btn.classList.remove('waiting-opponent');
      btn.textContent = 'play again :3';
      btn.disabled = false;
      document.getElementById('gameStatus').textContent = 'pick one!';

      document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.classList.remove('selected');
        btn.disabled = false;
      });

      startTimer();
    });

    socket.on('player_ready', ({ player }) => {
      console.log(`player ${player} ready`);
    });

    socket.on('opponent_ready', () => {
      const btn = document.getElementById('playAgainBtn');
      btn.textContent = 'friend is ready! :3';
    });

    socket.on('game_result', ({ player1, player2, result, timedOut }) => {
      if (timerInterval) clearInterval(timerInterval);

      const choices = cherryMode ? cherryEmojis : normalEmojis;
      const resultDiv = document.getElementById('result');

      let resultText = '';

      if (result === 'tie') {
        resultText = `${choices[player1]} vs ${choices[player2]}<br><br>tie! :'*`;
      } else {
        const winner = result === 'player1' ? player1 : player2;
        const loser = result === 'player1' ? player2 : player1;

        if (myChoice === winner) {
          myScore++;
          resultText = `${choices[winner]} beats ${choices[loser]}<br><br>you win! :3`;
        } else {
          theirScore++;
          resultText = `${choices[winner]} beats ${choices[loser]}<br><br>you lose :'(`;
        }
      }

      updateScore();
      resultDiv.innerHTML = resultText;
      resultDiv.style.display = 'block';
      document.getElementById('playAgainBtn').style.display = 'inline-block';
      document.getElementById('gameStatus').textContent = '';
    });

    socket.on('player_left', () => {
      if (timerInterval) clearInterval(timerInterval);
      showError("friend left the game :'(");
      setTimeout(() => {
        showScreen('menu');
        currentRoom = null;
        myChoice = null;
      }, 2000);
    });

    socket.on('error', (message) => {
      showError(message);
    });

    socket.on('reset_requested', () => {
      const scoreDiv = document.getElementById('score');
      scoreDiv.textContent = 'friend wants to reset!';
    });

    socket.on('reset_cancelled', () => {
      const scoreDiv = document.getElementById('score');
      scoreDiv.classList.remove('pending-reset');
      updateScore();
    });

    socket.on('score_reset', () => {
      myScore = 0;
      theirScore = 0;
      const scoreDiv = document.getElementById('score');
      scoreDiv.classList.remove('pending-reset');
      updateScore();
    });

    // Check for room code in URL
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const roomCode = urlParams.get('room');
      if (roomCode) {
        document.getElementById('roomInput').value = roomCode;

        // easter egg check for URL too :'*
        if (roomCode.toLowerCase() === 'kiraz') {
          setTimeout(() => {
            joinRoom();
          }, 100);
        } else {
          joinRoom();
        }
      }
    });
  </script>
</body>
</html>
