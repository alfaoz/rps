<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>rps</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Comic Neue', 'Comic Sans MS', 'Comic Sans', cursive;
      background: black;
      color: white;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
    }

    .container {
      max-width: 500px;
      width: 100%;
      text-align: center;
    }

    h1 {
      font-size: 1.5em;
      margin-bottom: 15px;
      font-weight: normal;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    button {
      font-family: 'Comic Neue', 'Comic Sans MS', 'Comic Sans', cursive;
      background: white;
      color: black;
      border: 2px solid white;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      margin: 5px 5px;
    }

    button.waiting-opponent {
      background: black;
      color: white;
      animation: blink 1s ease-in-out infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    button:hover {
      background: black;
      color: white;
    }

    button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .choice-btn {
      font-size: 3em;
      width: 80px;
      height: 80px;
      padding: 0;
      margin: 5px;
      background: black;
      color: white;
      border: 2px solid white;
    }

    .choice-btn:hover:not(:disabled) {
      background: white;
      color: black;
    }

    .choice-btn.selected {
      background: white;
      color: black;
    }

    input {
      font-family: 'Comic Neue', 'Comic Sans MS', 'Comic Sans', cursive;
      background: black;
      border: 2px solid white;
      color: white;
      padding: 10px;
      font-size: 1em;
      text-align: center;
      width: 150px;
      margin: 10px;
    }

    input:focus {
      outline: none;
      border-color: white;
    }

    .share-link {
      border: 2px solid white;
      padding: 15px;
      margin: 20px 0;
      cursor: pointer;
    }

    .share-link:hover {
      background: white;
      color: black;
    }

    .status {
      font-size: 1.2em;
      margin: 10px 0;
      min-height: 30px;
    }

    .result {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: black;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 40px 20px 20px;
    }

    .battle-emoji {
      font-size: 5em;
      margin: 10px 0;
      opacity: 0.7;
      transition: all 0.3s ease;
    }

    .battle-emoji.winner {
      opacity: 1;
      text-shadow: 0 0 20px white;
    }

    .battle-label {
      font-size: 0.9em;
      opacity: 0.6;
      margin-top: -10px;
    }

    .battle-outcome {
      font-size: 2.5em;
      margin: 20px 0;
      font-weight: bold;
    }

    .battle-score {
      font-size: 1em;
      opacity: 0.7;
      margin-top: 10px;
    }

    .win-streak {
      font-size: 1.2em;
      margin-top: 5px;
      color: white;
      font-weight: bold;
    }

    .win-streak.active {
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    .choice-btn.selected {
      background: white;
      color: black;
    }

    #playAgainBtn {
      position: relative;
      z-index: 1001;
    }

    .reactions {
      display: none;
      margin: 10px 0;
    }

    .reactions.active {
      display: block;
    }

    .reaction-btn {
      font-size: 1.5em;
      width: 45px;
      height: 45px;
      padding: 0;
      margin: 3px;
      background: black;
      color: white;
      border: 2px solid white;
      cursor: pointer;
    }

    .reaction-btn:hover {
      background: white;
      transform: scale(1.1);
    }

    .reaction-display {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 4em;
      z-index: 2000;
      animation: reactionPop 1.5s ease-out forwards;
      pointer-events: none;
    }

    @keyframes reactionPop {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5);
      }
      20% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.2);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -150%) scale(1);
      }
    }

    .error {
      margin: 20px 0;
      padding: 15px;
      border: 2px solid white;
    }

    .timer {
      font-size: 2em;
      margin: 5px 0;
      font-weight: bold;
    }

    small {
      font-size: 0.8em;
      opacity: 0.7;
    }

    .debug-info {
      font-size: 0.7em;
      margin: 5px 0;
      opacity: 0.5;
    }

    .score {
      font-size: 0.9em;
      margin: 10px 0;
      cursor: pointer;
      opacity: 0.7;
    }

    .score:hover {
      opacity: 1;
    }

    .score.pending-reset, .score.reset-incoming {
      animation: blink 1s ease-in-out infinite;
    }

    @keyframes fadeIn {
      0% {
        opacity: 0;
      }
      100% {
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>rock paper scissors!</h1>

    <!-- Menu Screen -->
    <div id="menu" class="screen active">
      <button onclick="createRoom()">create game</button>
      <br>
      <input type="text" id="roomInput" placeholder="room code" maxlength="5">
      <br>
      <button onclick="joinRoom()">join game</button>
      <div id="menuError" class="error" style="display: none;"></div>
    </div>

    <!-- Waiting Screen -->
    <div id="waiting" class="screen">
      <div class="status">room code:</div>
      <div class="share-link" id="shareLink" onclick="copyLink()">
        <div id="roomCode"></div>
        <small>click to copy link :3</small>
      </div>
      <div class="status">waiting for friend...</div>
    </div>

    <!-- Game Screen -->
    <div id="game" class="screen">
      <div id="debugInfo" class="debug-info" style="display: none;">ping: you <span id="myPing">0</span>ms | them <span id="theirPing">0</span>ms</div>
      <div class="score" id="score" onclick="toggleResetScore()">you: 0 | them: 0</div>
      <div class="win-streak" id="winStreak" style="display: none;"></div>
      <div class="timer" id="timer">3</div>
      <div class="status" id="gameStatus">pick one!</div>
      <div>
        <button class="choice-btn" onclick="selectChoice('rock')">‚úä</button>
        <button class="choice-btn" onclick="selectChoice('paper')">‚úã</button>
        <button class="choice-btn" onclick="selectChoice('scissors')">‚úåÔ∏è</button>
      </div>
      <div class="reactions" id="reactions">
        <button class="reaction-btn" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
        <button class="reaction-btn" onclick="sendReaction('üî•')">üî•</button>
        <button class="reaction-btn" onclick="sendReaction('üò≠')">üò≠</button>
        <button class="reaction-btn" onclick="sendReaction('üòî')">üòî</button>
        <button class="reaction-btn" onclick="sendReaction('üòµ‚Äçüí´')">üòµ‚Äçüí´</button>
      </div>
      <div id="result" class="result" style="display: none;"></div>
      <button onclick="playAgain()" style="display: none;" id="playAgainBtn">play again? :p</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoom = null;
    let myChoice = null;
    let selectedChoice = null;
    let timerInterval = null;
    let timeLeft = 3;
    let roundStartTime = null;
    let myScore = 0;
    let theirScore = 0;
    let winStreak = 0;
    let myPlayerIndex = null;
    let debugMode = false;
    let myPing = 0;
    let theirPing = 0;
    let pingInterval = null;

    const screens = {
      menu: document.getElementById('menu'),
      waiting: document.getElementById('waiting'),
      game: document.getElementById('game')
    };

    function showScreen(screenName) {
      Object.values(screens).forEach(screen => screen.classList.remove('active'));
      screens[screenName].classList.add('active');
    }

    function createRoom() {
      socket.emit('create_room');
    }

    function joinRoom() {
      const roomId = document.getElementById('roomInput').value.trim();
      if (!roomId) {
        showError('please enter a room code >:c');
        return;
      }

      // easter eggs :3
      if (roomId.toLowerCase() === 'kiraz') {
        showLoveMessage('i love you!!!! - alfa ‚ô•');
        return;
      }

      if (roomId.toLowerCase() === 'debug') {
        debugMode = true;
        document.getElementById('debugInfo').style.display = 'block';
        showError('debug mode enabled :3');
        document.getElementById('roomInput').value = '';
        startPingMeasurement();
        return;
      }

      socket.emit('join_room', roomId.toUpperCase());
    }

    function startTimer(serverStartTime) {
      roundStartTime = serverStartTime || Date.now();

      if (timerInterval) clearInterval(timerInterval);

      const updateTimer = () => {
        const elapsed = (Date.now() - roundStartTime) / 1000;
        timeLeft = Math.max(0, Math.ceil(3 - elapsed));
        document.getElementById('timer').textContent = timeLeft;

        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          if (!myChoice) {
            // Auto-submit selected choice or pick random
            if (selectedChoice) {
              makeChoice(selectedChoice, true);
            } else {
              const choices = ['rock', 'paper', 'scissors'];
              const randomChoice = choices[Math.floor(Math.random() * choices.length)];
              makeChoice(randomChoice, true);
            }
          }
        }
      };

      updateTimer();
      timerInterval = setInterval(updateTimer, 100); // Update more frequently for smoothness
    }

    function selectChoice(choice) {
      if (myChoice) return; // Already submitted

      selectedChoice = choice;

      // Update button states
      document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.classList.remove('selected');
      });

      const buttons = document.querySelectorAll('.choice-btn');
      const choiceMap = { rock: 0, paper: 1, scissors: 2 };
      buttons[choiceMap[choice]].classList.add('selected');

      document.getElementById('gameStatus').textContent = 'selected! (can change)';
    }

    function makeChoice(choice, auto = false) {
      if (myChoice) return;

      myChoice = choice;
      selectedChoice = null;
      socket.emit('make_choice', { roomId: currentRoom, choice });

      if (timerInterval) clearInterval(timerInterval);

      document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.classList.remove('selected');
        btn.disabled = true;
      });

      const buttons = document.querySelectorAll('.choice-btn');
      const choiceMap = { rock: 0, paper: 1, scissors: 2 };
      buttons[choiceMap[choice]].classList.add('selected');

      if (auto) {
        document.getElementById('gameStatus').textContent = "time up! auto-picked :O";
      } else {
        document.getElementById('gameStatus').textContent = 'waiting for friend...';
      }
      // keep showing time left instead of '-'
    }

    function playAgain() {
      const btn = document.getElementById('playAgainBtn');
      btn.classList.add('waiting-opponent');
      btn.textContent = 'waiting for friend...';
      btn.disabled = true;

      socket.emit('ready_for_next', { roomId: currentRoom });
    }

    function copyLink() {
      const url = window.location.href.split('?')[0] + '?room=' + currentRoom;

      // Try modern clipboard API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(() => {
          showCopiedMessage();
        }).catch(() => {
          fallbackCopy(url);
        });
      } else {
        // Fallback for HTTP sites
        fallbackCopy(url);
      }
    }

    function fallbackCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      document.body.appendChild(textArea);
      textArea.select();

      try {
        document.execCommand('copy');
        showCopiedMessage();
      } catch (err) {
        showCopiedMessage('room code: ' + currentRoom);
      }

      document.body.removeChild(textArea);
    }

    function showCopiedMessage(message = 'copied! :3') {
      const linkDiv = document.getElementById('shareLink');
      const code = currentRoom;
      linkDiv.innerHTML = `<div>${message}</div>`;
      setTimeout(() => {
        linkDiv.innerHTML = `<div id="roomCode">${code}</div><small>click to copy link :3</small>`;
      }, 1500);
    }

    function showError(message) {
      const errorDiv = document.getElementById('menuError');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 3000);
    }

    function showLoveMessage(message) {
      const titleElement = document.querySelector('h1');
      const originalTitle = titleElement.textContent;

      titleElement.textContent = 'i love you!!!!';
      titleElement.style.animation = 'fadeIn 0.5s ease-in-out';

      setTimeout(() => {
        titleElement.textContent = originalTitle;
        titleElement.style.animation = 'fadeIn 0.5s ease-in-out';
      }, 2000);
    }

    function updateScore() {
      document.getElementById('score').textContent = `you: ${myScore} | them: ${theirScore}`;
    }

    function updateStreak() {
      const streakDiv = document.getElementById('winStreak');
      if (winStreak >= 2) {
        streakDiv.textContent = `üî• ${winStreak} win streak! üî•`;
        streakDiv.style.display = 'block';
        streakDiv.classList.add('active');
      } else {
        streakDiv.style.display = 'none';
        streakDiv.classList.remove('active');
      }
    }

    function sendReaction(emoji) {
      if (!currentRoom) return;

      socket.emit('send_reaction', { roomId: currentRoom, emoji });

      // Show your own reaction locally
      displayReaction(emoji);
    }

    function displayReaction(emoji) {
      const reactionDiv = document.createElement('div');
      reactionDiv.className = 'reaction-display';
      reactionDiv.textContent = emoji;
      document.body.appendChild(reactionDiv);

      // Remove after animation completes
      setTimeout(() => {
        document.body.removeChild(reactionDiv);
      }, 1500);
    }

    function startPingMeasurement() {
      if (pingInterval) clearInterval(pingInterval);

      pingInterval = setInterval(() => {
        const start = Date.now();
        socket.emit('ping_request', { timestamp: start });
      }, 1000);
    }

    function updatePingDisplay() {
      if (debugMode) {
        document.getElementById('myPing').textContent = myPing;
        document.getElementById('theirPing').textContent = theirPing;
      }
    }

    function toggleResetScore() {
      const scoreDiv = document.getElementById('score');
      const hasPending = scoreDiv.classList.contains('pending-reset');
      const hasIncoming = scoreDiv.classList.contains('reset-incoming');

      if (hasIncoming) {
        // Agree to incoming reset request
        scoreDiv.classList.remove('reset-incoming');
        scoreDiv.classList.add('pending-reset');
        scoreDiv.textContent = 'resetting...';
        socket.emit('request_reset', { roomId: currentRoom });
      } else if (hasPending) {
        // Cancel reset
        scoreDiv.classList.remove('pending-reset');
        updateScore();
        socket.emit('cancel_reset', { roomId: currentRoom });
      } else {
        // Request reset
        scoreDiv.classList.add('pending-reset');
        scoreDiv.textContent = 'waiting for friend...';
        socket.emit('request_reset', { roomId: currentRoom });
      }
    }

    // Socket event listeners
    socket.on('room_created', (roomId) => {
      currentRoom = roomId;
      document.getElementById('roomCode').textContent = roomId;
      showScreen('waiting');
    });

    socket.on('room_joined', (roomId) => {
      currentRoom = roomId;
      showScreen('game');
    });

    socket.on('player_joined', ({ playerCount, startTime }) => {
      if (playerCount === 2) {
        showScreen('game');
        setTimeout(() => startTimer(startTime), 1000);
      }
    });

    socket.on('start_round', ({ startTime }) => {
      myChoice = null;
      selectedChoice = null;
      document.getElementById('result').style.display = 'none';
      document.getElementById('reactions').classList.remove('active');
      const btn = document.getElementById('playAgainBtn');
      btn.style.display = 'none';
      btn.classList.remove('waiting-opponent');
      btn.textContent = 'play again? :p';
      btn.disabled = false;
      document.getElementById('gameStatus').textContent = 'pick one!';

      document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.classList.remove('selected');
        btn.disabled = false;
      });

      startTimer(startTime);
    });

    socket.on('player_ready', ({ player }) => {
      console.log(`player ${player} ready`);
    });

    socket.on('opponent_ready', () => {
      const btn = document.getElementById('playAgainBtn');
      btn.textContent = 'friend is ready :O';
    });

    socket.on('game_result', ({ player1, player2, result, timedOut }) => {
      if (timerInterval) clearInterval(timerInterval);

      const choices = { rock: '‚úä', paper: '‚úã', scissors: '‚úåÔ∏è' };
      const resultDiv = document.getElementById('result');

      // Determine choices for display
      let theirChoice, myChoiceEmoji;
      if (myChoice === player1) {
        myChoiceEmoji = choices[player1];
        theirChoice = choices[player2];
      } else {
        myChoiceEmoji = choices[player2];
        theirChoice = choices[player1];
      }

      let resultText = '';
      let outcomeText = '';

      if (result === 'tie') {
        winStreak = 0; // Reset streak on tie
        outcomeText = 'tie! :O';
        resultText = `
          <div class="battle-emoji">${theirChoice}</div>
          <div class="battle-label">them</div>
          <div style="margin: 20px 0;"></div>
          <div class="battle-emoji">${myChoiceEmoji}</div>
          <div class="battle-label">you</div>
          <div class="battle-outcome" style="margin-top: 20px;">${outcomeText}</div>
          <div class="battle-score">you: ${myScore} | them: ${theirScore}</div>
        `;
      } else {
        const winner = result === 'player1' ? player1 : player2;

        if (myChoice === winner) {
          myScore++;
          winStreak++; // Increment streak
          outcomeText = 'you win!!';
          resultText = `
            <div class="battle-emoji">${theirChoice}</div>
            <div class="battle-label">them</div>
            <div style="margin: 20px 0;"></div>
            <div class="battle-emoji winner">${myChoiceEmoji}</div>
            <div class="battle-label">you</div>
            <div class="battle-outcome" style="margin-top: 20px;">${outcomeText}</div>
            <div class="battle-score">you: ${myScore} | them: ${theirScore}</div>
          `;
        } else {
          theirScore++;
          winStreak = 0; // Reset streak on loss
          outcomeText = "you lose :'(";
          resultText = `
            <div class="battle-emoji winner">${theirChoice}</div>
            <div class="battle-label">them</div>
            <div style="margin: 20px 0;"></div>
            <div class="battle-emoji">${myChoiceEmoji}</div>
            <div class="battle-label">you</div>
            <div class="battle-outcome" style="margin-top: 20px;">${outcomeText}</div>
            <div class="battle-score">you: ${myScore} | them: ${theirScore}</div>
          `;
        }
      }

      updateScore();
      updateStreak();
      resultDiv.innerHTML = resultText;
      resultDiv.style.display = 'block';
      document.getElementById('playAgainBtn').style.display = 'inline-block';
      document.getElementById('reactions').classList.add('active');
      document.getElementById('gameStatus').textContent = '';
    });

    socket.on('player_left', () => {
      if (timerInterval) clearInterval(timerInterval);
      showError("friend left the game :'(");
      setTimeout(() => {
        showScreen('menu');
        currentRoom = null;
        myChoice = null;
      }, 2000);
    });

    socket.on('error', (message) => {
      showError(message);
    });

    socket.on('reset_requested', () => {
      const scoreDiv = document.getElementById('score');
      scoreDiv.textContent = 'friend wants to reset! (click to agree)';
      scoreDiv.classList.add('reset-incoming');
    });

    socket.on('reset_cancelled', () => {
      const scoreDiv = document.getElementById('score');
      scoreDiv.classList.remove('pending-reset');
      scoreDiv.classList.remove('reset-incoming');
      updateScore();
    });

    socket.on('score_reset', () => {
      myScore = 0;
      theirScore = 0;
      const scoreDiv = document.getElementById('score');
      scoreDiv.classList.remove('pending-reset');
      scoreDiv.classList.remove('reset-incoming');
      updateScore();
    });

    socket.on('server_ping', ({ timestamp }) => {
      // Respond to server ping immediately
      socket.emit('server_pong', { timestamp });

      // Calculate own ping for debug mode
      const latency = Date.now() - timestamp;
      myPing = latency;
      updatePingDisplay();
    });

    socket.on('ping_response', ({ timestamp }) => {
      const latency = Date.now() - timestamp;
      myPing = latency;
      updatePingDisplay();
    });

    socket.on('opponent_ping', ({ ping }) => {
      theirPing = ping;
      updatePingDisplay();
    });

    socket.on('receive_reaction', ({ emoji }) => {
      displayReaction(emoji);
    });

    // Check for room code in URL
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const roomCode = urlParams.get('room');
      if (roomCode) {
        document.getElementById('roomInput').value = roomCode;

        // easter egg check for url aswell
        if (roomCode.toLowerCase() === 'kiraz') {
          setTimeout(() => {
            joinRoom();
          }, 100);
        } else {
          joinRoom();
        }
      }
    });
  </script>
</body>
</html>
